name: Validate and Deploy R4 & R5

on:
  push:
    branches: ['**']  # Deploy from any branch to matching branch
  workflow_dispatch:  # Allow manual triggering

jobs:
  # Validation jobs run first
  validate-r4:
    runs-on: ubuntu-latest
    name: Validate R4 IG
    
    steps:
      - uses: actions/checkout@v4

      - name: Install Jekyll
        run: sudo gem install jekyll

      - name: Install Sushi
        run: sudo npm install -g fsh-sushi

      - name: Preprocess
        run: |
          chmod u+x *.sh
          ./_preprocessMultiVersion.sh

      - name: Update IG publisher
        run: |
          pwd
          chmod +x ./_updatePublisher.sh
          ./_updatePublisher.sh -y
      
      - name: Validate R4 IG
        run: |
          pwd
          ./_genonce.sh

  validate-r5:
    runs-on: ubuntu-latest
    name: Validate R5 IG
    
    steps:
      - uses: actions/checkout@v4

      - name: Install Jekyll
        run: sudo gem install jekyll

      - name: Install Sushi
        run: sudo npm install -g fsh-sushi

      - name: Preprocess
        run: |
          chmod u+x *.sh
          ./_preprocessMultiVersion.sh

      - name: Update IG publisher
        working-directory: ./igs/mpd-r5
        run: |
          pwd
          chmod +x ./_updatePublisher.sh
          ./_updatePublisher.sh -y
      
      - name: Validate R5 IG
        working-directory: ./igs/mpd-r5
        run: |
          pwd
          ./_genonce.sh

  # Deployment job only runs if validation passes - R4 to root, R5 to separate repo
  deploy-r4-and-r5:
    runs-on: ubuntu-latest
    needs: [validate-r4, validate-r5]  # Wait for both validations to pass
    if: github.event_name == 'push' && github.event.head_commit.author.name != 'GitHub Actions Bot'
    
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for proper branch handling
          token: ${{ secrets.DEPLOY_TOKEN || github.token }}

      - name: Setup Git configuration
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Preprocess files
        run: |
          chmod u+x *.sh
          ./_preprocessMultiVersion.sh

      # === Deploy R4 to root of this repository ===
      - name: Commit and push R4 to root
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          echo "Deploying R4 build to root of current repo on branch: $BRANCH_NAME"
          
          # R4 files are already in root from preprocessing
          # Force add generated files even if in .gitignore
          git add -f sushi-config.yaml ig.ini LICENSE README.md publication-request.json
          git add -f input/
          git add -f ig-template/
          git add -f _genonce.sh _updatePublisher.sh
          
          if git diff --staged --quiet; then
            echo "No R4 content changes to commit"
          else
            git commit -m "Deploy R4 build to root - source: ${{ github.sha }}"
            git push origin $BRANCH_NAME
            echo "R4 build deployed to root of $BRANCH_NAME branch"
          fi

      # === Deploy R5 to separate repository ===
      - name: Clone R5 target repository
        env:
          DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
          R5_REPO_URL: ${{ vars.R5_REPO_URL || 'oijauregui/mpd-r5' }}
        run: |
          if [ -z "$DEPLOY_TOKEN" ]; then
            echo "Error: DEPLOY_TOKEN secret not configured. Please add a Personal Access Token with repo permissions."
            echo "Go to: Settings > Secrets and variables > Actions > New repository secret"
            echo "Name: DEPLOY_TOKEN"
            echo "Value: Your GitHub Personal Access Token"
            exit 1
          fi
          git clone https://$DEPLOY_TOKEN@github.com/$R5_REPO_URL.git r5-repo

      - name: Prepare R5 repository branch
        working-directory: ./r5-repo
        run: |
          # Get current branch name
          BRANCH_NAME="${{ github.ref_name }}"
          echo "Working with branch: $BRANCH_NAME"
          
          # Check if branch exists remotely
          if git ls-remote --heads origin $BRANCH_NAME | grep -q $BRANCH_NAME; then
            echo "Branch $BRANCH_NAME exists remotely, checking out"
            git checkout $BRANCH_NAME
          else
            echo "Branch $BRANCH_NAME doesn't exist, creating new branch"
            git checkout -b $BRANCH_NAME
          fi

      - name: Sync R5 content
        run: |
          # Remove all content from target repo except .git
          find ./r5-repo -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +

          # Copy mpd-r5 content to root of target repository
          cp -r ./igs/mpd-r5/* ./r5-repo/
          
          # Ensure hidden files are copied too (excluding .git)
          find ./igs/mpd-r5 -name ".*" -not -name ".git" -not -name "." -not -name ".." -exec cp -r {} ./r5-repo/ \; 2>/dev/null || true

      - name: Commit and push R5 changes
        working-directory: ./r5-repo
        run: |
          # Create a build trigger file to ensure there's always a commit for auto-ig-builder
          echo "Build triggered at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" > .build-trigger
          echo "Source commit: ${{ github.sha }}" >> .build-trigger
          echo "Source branch: ${{ github.ref_name }}" >> .build-trigger
          
          git add -A
          
          # Always commit to ensure auto-ig-builder triggers
          if git diff --staged --quiet; then
            echo "No content changes, but creating trigger commit for auto-ig-builder"
            git commit -m "Trigger auto-ig-builder - no content changes - source: ${{ github.sha }}"
          else
            git commit -m "Auto-sync from mpd repository - commit ${{ github.sha }}"
          fi
          
          git push origin ${{ github.ref_name }}
          echo "R5 repository updated successfully - auto-ig-builder should trigger"